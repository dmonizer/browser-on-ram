name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-deb:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - deb_arch: amd64
            cc: gcc
            pkg_config_path: /usr/lib/x86_64-linux-gnu/pkgconfig
            dpkg_arch: ""
            extra_pkgs: ""
          - deb_arch: arm64
            cc: aarch64-linux-gnu-gcc
            pkg_config_path: /usr/lib/aarch64-linux-gnu/pkgconfig
            dpkg_arch: arm64
            extra_pkgs: gcc-aarch64-linux-gnu libcap-dev:arm64
          - deb_arch: armhf
            cc: arm-linux-gnueabihf-gcc
            pkg_config_path: /usr/lib/arm-linux-gnueabihf/pkgconfig
            dpkg_arch: armhf
            extra_pkgs: gcc-arm-linux-gnueabihf libcap-dev:armhf

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add foreign architecture
        if: matrix.dpkg_arch != ''
        env:
          ARCH: ${{ matrix.dpkg_arch }}
        run: |
          sudo dpkg --add-architecture ${ARCH}
          # GitHub runners use amd64-only mirrors; restrict them and add ports.ubuntu.com for ARM
          if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then
            sudo sed -i '/^Types: deb/a Architectures: amd64' /etc/apt/sources.list.d/ubuntu.sources
          fi
          [ -f /etc/apt/sources.list ] && sudo sed -i 's/^deb /deb [arch=amd64] /g' /etc/apt/sources.list
          {
            echo "deb [arch=${ARCH}] http://ports.ubuntu.com/ubuntu-ports noble main restricted universe multiverse"
            echo "deb [arch=${ARCH}] http://ports.ubuntu.com/ubuntu-ports noble-updates main restricted universe multiverse"
            echo "deb [arch=${ARCH}] http://ports.ubuntu.com/ubuntu-ports noble-security main restricted universe multiverse"
          } | sudo tee /etc/apt/sources.list.d/ports-${ARCH}.list
          sudo apt-get update

      - name: Install build dependencies
        run: sudo apt-get install -y gcc libcap-dev ${{ matrix.extra_pkgs }}

      - name: Build
        run: PKG_CONFIG_PATH=${{ matrix.pkg_config_path }} make RELEASE=1 CC=${{ matrix.cc }}

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Package .deb
        run: |
          PKG_DIR="bor_${{ steps.version.outputs.version }}_${{ matrix.deb_arch }}"
          mkdir -p "${PKG_DIR}/DEBIAN"

          make RELEASE=1 PREFIX="${PWD}/${PKG_DIR}/usr" install

          cat > "${PKG_DIR}/DEBIAN/control" <<EOF
          Package: bor
          Version: ${{ steps.version.outputs.version }}
          Architecture: ${{ matrix.deb_arch }}
          Maintainer: dmonizer
          Depends: libcap2, libcap2-bin, rsync
          Description: Sync browser directories to RAM
           Speeds up browser, reduces disk writes, and automatically backs up data.
          EOF

          cat > "${PKG_DIR}/DEBIAN/postinst" <<'EOF'
          #!/bin/sh
          set -e

          detect_browsers() {
              if command -v firefox >/dev/null 2>&1 || command -v firefox-esr >/dev/null 2>&1; then echo firefox; fi
              if command -v chromium >/dev/null 2>&1 || command -v chromium-browser >/dev/null 2>&1; then echo chromium; fi
              if command -v google-chrome-stable >/dev/null 2>&1; then echo google-chrome-stable; fi
              if command -v google-chrome-beta >/dev/null 2>&1; then echo google-chrome-beta; fi
              if command -v google-chrome-unstable >/dev/null 2>&1; then echo google-chrome-unstable; fi
              if command -v vivaldi >/dev/null 2>&1; then echo vivaldi; fi
              if command -v vivaldi-snapshot >/dev/null 2>&1; then echo vivaldi-snapshot; fi
              if command -v opera >/dev/null 2>&1; then echo opera; fi
              if command -v brave >/dev/null 2>&1 || command -v brave-browser >/dev/null 2>&1; then echo brave; fi
              if command -v falkon >/dev/null 2>&1; then echo falkon; fi
              if command -v librewolf >/dev/null 2>&1; then echo librewolf; fi
          }

          setup_user() {
              username="$1"
              home="$2"
              uid="$3"
              config_file="${home}/.config/bor/bor.conf"

              if [ ! -f "$config_file" ]; then
                  browsers=$(detect_browsers)
                  if [ -n "$browsers" ]; then
                      mkdir -p "${home}/.config/bor"
                      chown "${username}:" "${home}/.config/bor"
                      printf '[config]\nenable_cache = false\nresync_cache = true\nenable_overlay = false\nmax_log_entries = 10\n\n[browsers]\n%s\n' \
                          "$browsers" > "$config_file"
                      chown "${username}:" "$config_file"
                  fi
              fi

              wants_dir="${home}/.config/systemd/user/default.target.wants"
              if [ ! -L "${wants_dir}/bor.service" ]; then
                  mkdir -p "$wants_dir"
                  ln -sf /usr/lib/systemd/user/bor.service "${wants_dir}/bor.service"
                  chown -R "${username}:" "${home}/.config/systemd"
              fi

              rm -f "${home}/.config/bor/.bor.conf"

              if [ -d "/run/user/${uid}" ] && [ -f "$config_file" ]; then
                  runuser -u "$username" -- env XDG_RUNTIME_DIR="/run/user/${uid}" HOME="$home" \
                      systemctl --user daemon-reload || true
                  runuser -u "$username" -- env XDG_RUNTIME_DIR="/run/user/${uid}" HOME="$home" \
                      systemctl --user start bor.service || true
              fi
          }

          case "$1" in
              configure)
                  setcap 'cap_dac_override,cap_sys_admin=p' /usr/bin/bor
                  while IFS=: read -r username _ uid _ _ homedir _; do
                      [ "${uid}" -ge 1000 ] 2>/dev/null || continue
                      [ -d "$homedir" ] || continue
                      setup_user "$username" "$homedir" "$uid"
                  done < /etc/passwd
                  ;;
          esac
          EOF
          chmod 755 "${PKG_DIR}/DEBIAN/postinst"

          dpkg-deb --build "${PKG_DIR}"

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: bor_*.deb
          generate_release_notes: true
