name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-deb:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: sudo apt-get install -y gcc libcap-dev

      - name: Build
        run: make RELEASE=1

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Package .deb
        run: |
          PKG_DIR="bor_${{ steps.version.outputs.version }}_amd64"
          mkdir -p "${PKG_DIR}/DEBIAN"

          make RELEASE=1 PREFIX="${PWD}/${PKG_DIR}/usr" install

          cat > "${PKG_DIR}/DEBIAN/control" <<EOF
          Package: bor
          Version: ${{ steps.version.outputs.version }}
          Architecture: amd64
          Maintainer: dmonizer
          Depends: libcap2, libcap2-bin, rsync
          Description: Sync browser directories to RAM
           Speeds up browser, reduces disk writes, and automatically backs up data.
          EOF

          cat > "${PKG_DIR}/DEBIAN/postinst" <<'EOF'
          #!/bin/sh
          set -e
          setcap 'cap_dac_override,cap_sys_admin=p' /usr/bin/bor
          EOF
          chmod 755 "${PKG_DIR}/DEBIAN/postinst"

          dpkg-deb --build "${PKG_DIR}"

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: bor_*.deb
          generate_release_notes: true
